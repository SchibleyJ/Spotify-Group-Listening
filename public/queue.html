<html>
<link rel='stylesheet' type='text/css' href='queue.css'>
<meta content="width=device-width, initial-scale=1" name="viewport" />
<body>
    <a style="border: none 0px white;" href="/">
        <img class="homeButton" src="img/home.png"></img>
    </a>
    <div onclick="clearsearch()" class="container">
        <div class="search-bar">
            <p style="margin-top: 10px;"class="spotify-text">Search for Songs:</p>
            <input name="search" type="text" class="search" id="search" value="">
            <button onclick="search()"><span class="small-text">Search</span></button>
        </div>
        <p class="small-text" style="color: grey" id="search-info-p"></p>
        <div class="results">
            <div class="song" id="song0" onclick="getURI(0)">
                <image src='./img/temp.png' class="picture" id="song0picture">
                </image>
                <div class="song-info">
                    <div class="name" id="song0name"></div>
                    <div class="artists" id="song0artists"></div>
                </div>
            </div>
            <div class="song" id="song1" onclick="getURI(1)">
                <image src='./img/temp.png' class="picture" id="song1picture">
                </image>
                <div class="song-info">
                    <div class="name" id="song1name"></div>
                    <div class="artists" id="song1artists"></div>
                </div>
            </div>
            <div class="song" id="song2" onclick="getURI(2)">
                <image src='./img/temp.png' class="picture" id="song2picture">
                </image>
                <div class="song-info">
                    <div class="name" id="song2name"></div>
                    <div class="artists" id="song2artists"></div>
                </div>
            </div>
            <div class="song" id="song3" onclick="getURI(3)">
                <image src='./img/temp.png'class="picture" id="song3picture">
                </image>
                <div class="song-info">
                    <div class="name" id="song3name"></div>
                    <div class="artists" id="song3artists"></div>
                </div>
            </div>
            <div class="song" id="song4" onclick="getURI(4)">
                <image src='./img/temp.png' class="picture" id="song4picture">
                </image>
                <div class="song-info">
                    <div class="name" id="song4name"></div>
                    <div class="artists" id="song4artists"></div>
                </div>

            </div>
        </div>
        <div class="info"></div>
    </div>

</body>
<script>
    let currentSearchData;

    const getURI = (songNum) => {
        postURI(currentSearchData[songNum].uri);
    }

    const postURI = (uri) => {
        fetch(`${window.location.origin}/queue`, {
            method: "POST",
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ "uri": uri, "code": getCookie('room') })
        }).then(res => {
            for (let i = 0; i < 5; i++) {
                document.getElementById(`song${i}picture`).src = './img/temp.png';
                document.getElementById(`song${i}name`).innerHTML = null;
                document.getElementById(`song${i}artists`).innerHTML = null;
            }
            document.getElementById('search-info-p').innerHTML = "Song successfully queued.";
        });
    }
    const getCookie = (name) => {
        var nameEQ = name + "=";
        var ca = document.cookie.split(';');
        for (var i = 0; i < ca.length; i++) {
            var c = ca[i];
            while (c.charAt(0) == ' ') c = c.substring(1, c.length);
            if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);
        }
        return null;
    }

    const getSearchResults = (search) => {
        fetch(`${window.location.origin}/search`, {
            method: "POST",
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ "search": search, "code": getCookie('room') })
        }).then(res => {
            return res.json();
        }).then((data) => {
            currentSearchData = data;
            for (let i = 0; i < data.length; i++) {
                document.getElementById(`song${i}picture`).src = data[i].image;
                document.getElementById(`song${i}name`).innerHTML = shorten(data[i].name);
                document.getElementById(`song${i}artists`).innerHTML = shorten(data[i].artists.join(', '));
            }
            document.getElementById('search-info-p').innerHTML = "Showing top 5 results:";
        });
    }

    const search = () => {
        getSearchResults(document.getElementById('search').value);
        document.getElementById('search').value = null;
    }

    const shorten = (text) => {
        if (text.length > 20) {
            return text.substring(0, 20) + "...";
        } else {
            return text
        }

    }

    const clearsearch = () => {
        if (document.getElementById('search-info-p').innerHTML[1] == "o")
        document.getElementById('search-info-p').innerHTML = "";
    }
</script>

</html>